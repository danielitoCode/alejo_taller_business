<script lang="ts">
    import type { NavController } from "../../../../lib/navigation/NavController";
    import { authContainer } from "../../di/auth.container";

    export let navController: NavController;

    let email = "";
    let password = "";
    let loading = false;
    let error: string | null = null;
    let contentVisible = false;

    const glowAlpha = 0.45;

    $: canSubmit = email.trim().length > 3 && password.trim().length > 3 && !loading;

    setTimeout(() => {
        contentVisible = true;
    }, 20);

    async function signIn() {
        if (!canSubmit) return;

        loading = true;
        error = null;

        try {
            const userId = await authContainer.useCases.sessions.openSession.openCustomSession(
                email.trim(),
                password
            );
            navController.navigate("home", { id: userId });
        } catch (e) {
            error = e instanceof Error ? e.message : "No se pudo iniciar sesión";
        } finally {
            loading = false;
        }
    }

    function continueWithGoogle() {
        error = "Inicio con Google no disponible en esta versión web.";
    }

    function goToRegister() {
        navController.navigate("register");
    }
</script>

<section class="login-screen" aria-label="Iniciar sesión">
    <div class="login-shell {contentVisible ? 'is-visible' : ''}">
        <section class="login-title">
            <div class="surface-icon" style={`--glow:${glowAlpha}`}>
                <div class="loader-ring" aria-hidden="true"></div>
                <img src="/alejoicon_clean.svg" alt="App icon" class="logo" />
            </div>
            <h1>Iniciar sesión</h1>
            <p>Accede con tu cuenta para continuar.</p>
        </section>

        <section class="form-card" aria-label="Formulario de acceso">
            <label class="field">
                <span>Correo</span>
                <input type="email" bind:value={email} placeholder="correo@dominio.com" autocomplete="email" />
            </label>

            <label class="field">
                <span>Contraseña</span>
                <input type="password" bind:value={password} placeholder="••••••••" autocomplete="current-password" />
            </label>

            {#if error}
                <p class="error">{error}</p>
            {/if}

            <div class="actions">
                <button class="btn primary" on:click={signIn} disabled={!canSubmit}>
                    {#if loading}Entrando...{:else}Entrar{/if}
                </button>

                <button class="btn elevated" on:click={continueWithGoogle} disabled={loading}>
                    <span>Google</span>
                    <span class="g-badge">G</span>
                </button>
            </div>

            <button class="link-btn" on:click={goToRegister}>
                ¿No tienes cuenta? Regístrate
            </button>
        </section>
    </div>
</section>

<style>
    .login-screen {
        min-height: 100dvh;
        width: 100%;
        display: grid;
        place-items: center;
        padding: 15px;
        background:
                radial-gradient(circle at 50% 10%, color-mix(in srgb, var(--md-sys-color-primary) 24%, transparent), transparent 50%),
                var(--md-sys-color-background);
    }

    .login-shell {
        width: min(100%, 980px);
        display: grid;
        gap: 24px;
        opacity: 0;
        transform: translateY(20px);
        transition: opacity 650ms ease, transform 650ms ease;
    }

    .login-shell.is-visible {
        opacity: 1;
        transform: translateY(0);
    }

    .login-title {
        display: grid;
        justify-items: center;
        text-align: center;
        gap: 8px;
    }

    .surface-icon {
        width: min(180px, 42vw);
        aspect-ratio: 1;
        position: relative;
        display: grid;
        place-items: center;
    }

    .loader-ring {
        position: absolute;
        inset: 0;
        border-radius: 28%;
        border: 7px solid color-mix(in srgb, var(--md-sys-color-primary-container) calc(var(--glow) * 100%), transparent);
        animation: pulse 600ms ease-in-out infinite alternate;
    }

    .logo {
        width: 70%;
        height: 70%;
        object-fit: contain;
        filter: drop-shadow(0 8px 15px color-mix(in srgb, var(--md-sys-color-primary) 30%, transparent));
    }

    h1 {
        margin: 0;
        color: var(--md-sys-color-on-background);
        font-size: clamp(1.8rem, 4vw, 2.1rem);
    }

    p {
        margin: 0;
        color: color-mix(in srgb, var(--md-sys-color-on-background) 75%, transparent);
    }

    .form-card {
        width: 100%;
        max-width: 520px;
        justify-self: center;
        background: var(--md-sys-color-surface);
        border: 1px solid var(--md-sys-color-outline-variant);
        border-radius: 20px;
        padding: 20px;
        display: grid;
        gap: 10px;
        box-shadow: 0 10px 24px color-mix(in srgb, var(--md-sys-color-outline) 20%, transparent);
    }

    .field {
        display: grid;
        gap: 6px;
    }

    .field span {
        font-size: 0.92rem;
        color: var(--md-sys-color-on-surface-variant);
    }

    input {
        width: 100%;
        border: 1px solid var(--md-sys-color-outline-variant);
        border-radius: 12px;
        height: 44px;
        padding: 0 12px;
        font: inherit;
        color: var(--md-sys-color-on-surface);
        background: color-mix(in srgb, var(--md-sys-color-surface) 88%, var(--md-sys-color-surface-variant));
    }

    .error {
        color: var(--md-sys-color-error);
        font-size: 0.92rem;
    }

    .actions {
        margin-top: 5px;
        display: grid;
        gap: 10px;
    }

    .btn {
        height: 52px;
        border-radius: 14px;
        border: 0;
        cursor: pointer;
        font-size: 1rem;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
    }

    .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .primary {
        color: var(--md-sys-color-on-primary);
        background: var(--md-sys-color-primary);
    }

    .elevated {
        color: var(--md-sys-color-on-surface);
        background: var(--md-sys-color-surface);
        border: 1px solid var(--md-sys-color-outline-variant);
    }

    .g-badge {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        display: inline-grid;
        place-items: center;
        font-size: 0.8rem;
        background: #fff;
        color: #4285f4;
        font-weight: 700;
    }

    .link-btn {
        margin-top: 4px;
        border: 0;
        background: transparent;
        color: var(--md-sys-color-primary);
        cursor: pointer;
        justify-self: center;
    }

    @media (min-width: 900px), (orientation: landscape) and (max-height: 650px) {
        .login-shell {
            grid-template-columns: 1fr 1fr;
            align-items: center;
            gap: 18px;
        }

        .login-title {
            justify-items: center;
            align-content: center;
            min-height: 420px;
        }

        .form-card {
            max-width: none;
            align-self: stretch;
            align-content: center;
        }

        .actions {
            grid-template-columns: 1fr 1fr;
        }
    }

    @keyframes pulse {
        from { opacity: 0.12; }
        to { opacity: 0.78; }
    }
</style>